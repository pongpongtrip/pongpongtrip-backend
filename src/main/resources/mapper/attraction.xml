<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enjoytrip.ws.attraction.model.mapper.AttractionMapper">

	<resultMap type="AttractionDto" id="attraction">
		<result column="first_image" property="first_image"/>
		<result column="content_id" property="content_id"/>
		<result column="title" property="title"/>
		<result column="addr1" property="addr1"/>
		<result column="latitude" property="latitude"/>
		<result column="longitude" property="longitude"/>
	</resultMap>
	
	<resultMap type="AttractionDetailDto" id="attractionDetail">
		<result column="first_image" property="first_image"/>
		<result column="content_id" property="content_id"/>
		<result column="title" property="title"/>
		<result column="addr1" property="addr1"/>
		<result column="latitude" property="latitude"/>
		<result column="longitude" property="longitude"/>
		<result column="hit" property="hit"/>
		<result column="homepage" property="homepage"/>
		<result column="overview" property="overview"/>
		<result column="telname" property="telname"/>
	</resultMap>
	
	<resultMap type="AttractionPlanDto" id="attractionPlan">
		<result column="plan_id" property="planId"/>
		<result column="plan_name" property="planName"/>
		<result column="content_id" property="contentId"/>
		<result column="time" property="time"/>
		<result column="user_id" property="userId"/>
		<result column="user_name" property="userName"/>
	</resultMap>
	
	<resultMap type="AttractionLikeDto" id="attractionLike">
		<result column="user_id" property="user_id"/>
		<result column="content_id" property="content_id"/>
	</resultMap>
	
	<resultMap type="AttractionPlanDetailDto" id="attractionPlanDetail">
		<result column="first_image" property="first_image"/>
		<result column="content_id" property="content_id"/>
		<result column="title" property="title"/>
		<result column="addr1" property="addr1"/>
		<result column="latitude" property="latitude"/>
		<result column="longitude" property="longitude"/>
		<result column="hit" property="hit"/>
		<result column="homepage" property="homepage"/>
		<result column="overview" property="overview"/>
		<result column="plan_id" property="planId"/>
		<result column="content_id" property="contentId"/>
		<result column="time" property="time"/>
		<result column="user_id" property="userId"/>
		<result column="user_name" property="userName"/>
		<result column="plan_name" property="planName"/>
	</resultMap>

	<select id="attractionList" parameterType="map" resultMap="attractionDetail">
		select *	
		from attraction_info_description as A join hotplace as B on A.content_id = B.content_id
		where sido_code=#{sido_code} AND content_type_id=#{content_type_id} AND title like concat('%',#{title},'%')
		order by B.hit desc;
	</select>
	
	<select id="hotAttractionList" parameterType="map" resultMap="attractionDetail">
		select *	
		from attraction_info_description as A join hotplace as B on A.content_id = B.content_id
		order by B.hit desc;

	</select>
	
	<select id="maxIndex" resultType="int">
		select coalesce(max(plan_id), 0)
		from plan;
	</select>
	
	<insert id="writePlan" parameterType="AttractionPlanDto">
		insert into plan (plan_id, plan_name, content_id, `time`, user_id, user_name)
		values (#{planId}, #{planName}, #{contentId}, #{time}, #{userId}, #{userName})
	</insert>
	
	<update id="updateHit" parameterType="int">
		update hotplace
		set hit = hit + 1
		where content_id = #{contentId}
	</update>
	
	<insert id="likeAttraction" parameterType="AttractionLikeDto">
		insert into member_like_place (user_id, content_id)
		values (#{user_id}, #{content_id})
	</insert>
	
	<delete id="dislikeAttraction" parameterType="AttractionLikeDto">
		delete from member_like_place
		where user_id=#{user_id} and content_id=#{content_id}
	</delete>
	
	<select id="myHotPlace" parameterType="AttractionLikeDto" resultMap="attractionDetail">
		select *
		from attraction_info_description
		where content_id IN (
			select content_id 
			from member_like_place
			where user_id=#{user_id}
		)
	</select>
	
	<select id="myPlans" parameterType="AttractionPlanDto" resultMap="attractionPlanDetail">
		select *
		from attraction_info_description as A Join 
		(select plan_name, plan_id,content_id, time, user_id
		from plan
		where user_id=#{userId} and delflag=0) as B on A.content_id = B.content_id
		order by plan_id, time asc
	</select>
	
	<update id="deletePlan" parameterType="AttractionPlanDto">
		update plan set delflag=1 
		where plan_id=#{planId} and plan_id=#{planId}
	</update>
</mapper>